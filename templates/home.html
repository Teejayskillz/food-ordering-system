{% extends "base.html" %}
{% load static %}
{% block title %}Home{% endblock %}
{% block content %}

<style>
  /* HERO with background image + overlay (Uber Eats vibe) */
  .hero-wrap {
    position: relative;
    overflow: hidden;
    border-radius: 22px;
    border: 1px solid rgba(255, 255, 255, .10);
    min-height: 420px;

    /* Put your hero image here */
    background: linear-gradient(90deg,
      rgba(11, 18, 32, .90) 0%,
      rgba(11, 18, 32, .75) 45%,
      rgba(11, 18, 32, .30) 75%,
      rgba(11, 18, 32, .12) 100%),
    url("{% static 'img/hero-food.jpg' %}") center/cover no-repeat;
  }

  .hero-blur {
    position: absolute;
    inset: 0;
    background:
      radial-gradient(800px 300px at 10% 10%, rgba(255, 193, 7, .22), transparent 60%),
      radial-gradient(700px 300px at 90% 20%, rgba(13, 110, 253, .18), transparent 55%);
    opacity: .95;
    pointer-events: none;
  }

  .stat-card {
    background: rgba(255, 255, 255, .06);
    border: 1px solid rgba(255, 255, 255, .10);
    border-radius: 18px;
    backdrop-filter: blur(10px);
  }

  .mini-card {
    background: rgba(255, 255, 255, .05);
    border: 1px solid rgba(255, 255, 255, .10);
    border-radius: 18px;
    backdrop-filter: blur(10px);
  }

  .pill-chip {
    background: rgba(255, 255, 255, .10);
    border: 1px solid rgba(255, 255, 255, .12);
    color: rgba(255, 255, 255, .85);
  }

  /* Map box */
  #homeMap {
    width: 100%;
    height: 250px;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, .10);
    background: rgba(255, 255, 255, .04);
  }

  .map-hint {
    font-size: .85rem;
    color: rgba(255, 255, 255, .65);
  }
</style>

<!-- HERO (Premium) with MAP -->
<section class="hero-wrap p-4 p-md-5 mb-4">
  <div class="hero-blur"></div>

  <div class="row align-items-center g-4 position-relative">
    <div class="col-lg-7">
      <div class="d-flex flex-wrap gap-2 mb-3">
        <span class="badge rounded-pill pill-chip">Fast delivery</span>
        <span class="badge rounded-pill pill-chip">Fresh meals</span>
        <span class="badge rounded-pill pill-chip">Easy checkout</span>
      </div>

      <h1 class="fw-bold display-6 mb-2">Order food without stress.</h1>
      <p class="text-white-50 mb-4" style="max-width: 52ch;">
        Pick a delivery point, browse meals, add to cart, and checkout in minutes.
        Track your orders anytime from your dashboard.
      </p>

      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-warning btn-lg rounded-pill px-4" href="{% url 'menu:menu_list' %}">
          Browse Menu
        </a>
        <a class="btn btn-outline-light btn-lg rounded-pill px-4" href="{% url 'orders:cart' %}">
          View Cart
        </a>
      </div>

      <div class="d-flex flex-wrap gap-3 mt-4">
        <div class="stat-card p-3">
          <div class="text-white-50 small">Cart items</div>
          <div class="fw-bold fs-4">{{ cart_count|default:0 }}</div>
        </div>
        <div class="stat-card p-3">
          <div class="text-white-50 small">Ordering</div>
          <div class="fw-bold fs-4">Simple</div>
        </div>
        <div class="stat-card p-3">
          <div class="text-white-50 small">Checkout</div>
          <div class="fw-bold fs-4">Quick</div>
        </div>
      </div>
    </div>

    <!-- Right side (Map + Today's pick) -->
    <div class="col-lg-5">
      <div class="mini-card p-4 mb-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <div class="fw-semibold">Choose delivery area</div>
            <div class="map-hint">Tap the map to set a delivery point.</div>
          </div>
          <span class="badge rounded-pill text-bg-warning text-dark">Live</span>
        </div>

        <div id="homeMap" class="mb-3"></div>

        <input type="hidden" id="delivery_point" name="delivery_point" value="">
        <div class="text-white-50 small mb-3" id="pickedText">No delivery point selected yet.</div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-light btn-sm rounded-pill flex-grow-1" type="button" id="useMyLocationBtn">
            Use my location
          </button>
          <a class="btn btn-warning btn-sm rounded-pill flex-grow-1" href="{% url 'menu:menu_list' %}">
            Order now
          </a>
        </div>
      </div>

      <div class="mini-card p-4">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <div class="fw-semibold">Today’s pick</div>
            <div class="text-white-50 small">From featured meals</div>
          </div>
          <span class="badge rounded-pill text-bg-warning text-dark">Hot</span>
        </div>

        {% if featured and featured.0 %}
        <div class="d-flex gap-3 align-items-center">
          <div class="rounded-4 overflow-hidden"
            style="width:92px; height:92px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08);">
            {% if featured.0.image %}
            <img src="{{ featured.0.image.url }}" alt="{{ featured.0.name }}"
              style="width:100%; height:100%; object-fit:cover;">
            {% else %}
            <div class="h-100 d-flex align-items-center justify-content-center text-white-50 small">No image</div>
            {% endif %}
          </div>
          <div class="flex-grow-1">
            <div class="fw-semibold">{{ featured.0.name }}</div>
            <div class="text-white-50 small">{{ featured.0.category.name }}</div>
            <div class="fw-bold mt-1">₦{{ featured.0.price }}</div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <a class="btn btn-outline-light btn-sm rounded-pill flex-grow-1"
            href="{% url 'menu:food_detail' featured.0.id %}">
            View
          </a>
          <a class="btn btn-warning btn-sm rounded-pill flex-grow-1"
            href="{% url 'orders:add_to_cart' featured.0.id %}?next={{ request.get_full_path|urlencode }}">
            Add to Cart
          </a>
        </div>
        {% else %}
        <p class="mb-0 text-white-50">Add featured meals to display a pick here.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- HOW IT WORKS -->
<section class="mb-4">
  <div class="d-flex align-items-end justify-content-between mb-3">
    <div>
      <h4 class="mb-1">How it works</h4>
      <p class="text-white-50 small mb-0">A simple flow that feels like a real app.</p>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="mini-card p-4 h-100">
        <div class="fw-semibold mb-1">1) Browse meals</div>
        <div class="text-white-50 small">Filter by category and check details.</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="mini-card p-4 h-100">
        <div class="fw-semibold mb-1">2) Add to cart</div>
        <div class="text-white-50 small">Update quantities anytime in your cart.</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="mini-card p-4 h-100">
        <div class="fw-semibold mb-1">3) Checkout</div>
        <div class="text-white-50 small">Enter delivery info and place your order.</div>
      </div>
    </div>
  </div>
</section>

<!-- FEATURED -->
<section>
  <div class="d-flex align-items-end justify-content-between mb-3">
    <div>
      <h4 class="mb-1">Featured Meals</h4>
      <p class="text-white-50 small mb-0">Popular picks available today.</p>
    </div>
    <a class="btn btn-outline-light btn-sm rounded-pill" href="{% url 'menu:menu_list' %}">
      See full menu →
    </a>
  </div>

  <div class="row g-3">
    {% for f in featured %}
    <div class="col-sm-6 col-lg-4">
      <div class="card h-100 text-light border-0 overflow-hidden"
        style="background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.08); border-radius: 18px;">

        {% if f.image %}
        <img src="{{ f.image.url }}" class="card-img-top" alt="{{ f.name }}" style="height:200px; object-fit:cover;">
        {% else %}
        <div class="d-flex align-items-center justify-content-center"
          style="height:200px; background: rgba(255,255,255,.06);">
          <span class="small text-white-50">No image</span>
        </div>
        {% endif %}

        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="badge rounded-pill"
              style="background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.14);">
              {{ f.category.name }}
            </span>
            <span class="fw-semibold">₦{{ f.price }}</span>
          </div>

          <h5 class="card-title mb-1">{{ f.name }}</h5>

          <p class="card-text small text-white-50 mb-3">
            {{ f.description|truncatewords:15 }}
          </p>

          <div class="mt-auto d-flex gap-2">
            <a class="btn btn-outline-light btn-sm rounded-pill flex-grow-1"
              href="{% url 'menu:food_detail' f.id %}">View</a>
            <a class="btn btn-warning btn-sm rounded-pill flex-grow-1"
              href="{% url 'orders:add_to_cart' f.id %}?next={{ request.get_full_path|urlencode }}">Add to Cart</a>
          </div>
        </div>

      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="p-4 rounded-4" style="background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08);">
        <p class="mb-0 text-white-50">No featured meals available.</p>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<!-- Leaflet Map (no API key) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  (function () {
    // Default: Lagos (change if you want)
    const defaultLatLng = [6.5244, 3.3792];

    const map = L.map('homeMap', { zoomControl: true }).setView(defaultLatLng, 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;

    function setPoint(lat, lng) {
      const val = lat.toFixed(6) + ',' + lng.toFixed(6);
      document.getElementById('delivery_point').value = val;
      document.getElementById('pickedText').textContent = 'Selected point: ' + val;

      if (marker) marker.setLatLng([lat, lng]);
      else marker = L.marker([lat, lng]).addTo(map);
    }

    map.on('click', function (e) {
      setPoint(e.latlng.lat, e.latlng.lng);
    });

    document.getElementById('useMyLocationBtn').addEventListener('click', function () {
      if (!navigator.geolocation) {
        document.getElementById('pickedText').textContent = 'Geolocation not supported on this browser.';
        return;
      }
      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          map.setView([lat, lng], 14);
          setPoint(lat, lng);
        },
        function () {
          document.getElementById('pickedText').textContent = 'Could not get your location (permission denied or unavailable).';
        },
        { enableHighAccuracy: true, timeout: 8000 }
      );
    });
  })();
</script>

{% endblock %}